name: Keep Supabase Active

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  supabase-workflow:
    runs-on: ubuntu-latest
      
    steps:
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Supabase Client
        run: npm install @supabase/supabase-js
      
      - name: Generate data with Gemini AI
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          AI_MODEL: ${{vars.AI_MODEL}}
          AI_PROMPT: ${{vars.AI_PROMPT}}
        run: |
          echo "ğŸ¤– Generating data with Gemini AI..."
          curl "https://generativelanguage.googleapis.com/v1beta/models/${AI_MODEL}:generateContent?key=${GEMINI_API_KEY}" \
            -H 'Content-Type: application/json' \
            -X POST \
            -d '{
              "contents": [
                {
                  "parts": [
                    {
                      "text": "'"${AI_PROMPT}"'"
                    }
                  ]
                }
              ]
            }' > gemini_response.json
          echo "âœ… Data saved to gemini_response.json"
          ls -la gemini_response.json

      - name: Extract generated data from Gemini response
        run: |
          echo "ğŸ” Extracting generated data from Gemini response..."
          node -e "
          const fs = require('fs');
          const response = JSON.parse(fs.readFileSync('gemini_response.json', 'utf8'));
          let text = '';
          try {
            text = response.candidates[0].content.parts[0].text;
          } catch (e) {
            console.error('âŒ Failed to extract text from Gemini response:', e.message);
            process.exit(1);
          }
          // ç”Ÿæˆã•ã‚ŒãŸæ–‡å­—åˆ—ã®ã¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          fs.writeFileSync('generated_data.json', text);
          console.log('âœ… Extracted and saved to generated_data.json');
          "
      
      - name: Run Supabase Activity
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          TABLE_NAME: ${{vars.TABLE_NAME}}
        run: |
          node -e "
          (async () => {
            try {
              const fs = require('fs');
              const { createClient } = require('@supabase/supabase-js');
              
              const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_ANON_KEY);
              
              console.log('ğŸš€ Starting Supabase activity workflow');
              
              // ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
              const rawData = fs.readFileSync('generated_data.json', 'utf8');

              // JSONè§£æ
              let contentArray;
              try {
                contentArray = JSON.parse(rawData.trim());
              } catch (parseError) {
                console.error('âŒ JSON parse failed:', parseError.message);
                throw new Error('AI output is not valid JSON');
              }

              // é…åˆ—ã‹ã©ã†ã‹æ¤œè¨¼
              if (!Array.isArray(contentArray)) {
                console.error('âŒ AI output is not an array:', typeof contentArray);
                throw new Error('Expected JSON array but got: ' + typeof contentArray);
              }

              // è¦ç´ ã®å‹æ¤œè¨¼
              const invalidItems = contentArray.filter((item, index) => {
                if (typeof item !== 'string') {
                  console.warn(\`âš ï¸ Item \${index} is not a string:\`, typeof item);
                  return true;
                }
                return false;
              });

              if (invalidItems.length > 0) {
                console.error(\`âŒ Found \${invalidItems.length} non-string items in array\`);
                throw new Error('Array contains non-string elements');
              }

              console.log('âœ… AI output validation passed');
              console.log(\`ğŸ“Š Valid array with \${contentArray.length} string elements\`);

              // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—ã«å¤‰æ›
              const data = contentArray.map(content => ({ content }));
              
              // ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥
              const { error } = await supabase.from(process.env.TABLE_NAME).insert(data);
              if (error) throw error;
              console.log('âœ… Inserted records successfully');
              
              // å¤ã„ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆ24æ™‚é–“ä»¥ä¸Šå‰ï¼‰
              const { error: deleteError } = await supabase
                .from(process.env.TABLE_NAME)
                .delete()
                .lt('created_at', new Date(Date.now() - 24*60*60*1000).toISOString());
              
              if (deleteError) console.warn('âš ï¸ Cleanup warning:', deleteError.message);
              else console.log('ğŸ§¹ Cleaned up old records');
              
              console.log('ğŸ‰ Workflow completed successfully!');
              
            } catch (err) {
              console.error('âŒ Error:', err.message);
              process.exit(1);
            }
          })();
          "
