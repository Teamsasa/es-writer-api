name: Keep Supabase Active

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

permissions:
  contents: read
  models: read

jobs:
  supabase-workflow:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      AI_MODEL: ${{vars.AI_MODEL}}
      AI_PROMPT: ${{vars.AI_PROMPT}}
      TABLE_NAME: ${{vars.TABLE_NAME}}
      
    steps:
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Supabase Client
        run: npm install @supabase/supabase-js
      
      - name: Setup gh models extension
        run: gh extension install github/gh-models
      
      - name: Generate data with AI
        run: |
          echo "ğŸ¤– Generating data with AI..."
          gh models run $AI_MODEL "$AI_PROMPT" > generated_data.json
          echo "âœ… Data saved to generated_data.json"
          ls -la generated_data.json
      
      - name: Run Supabase Activity
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          node -e "
          (async () => {
            try {
              const fs = require('fs');
              const { createClient } = require('@supabase/supabase-js');
              
              const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_ANON_KEY);
              
              console.log('ğŸš€ Starting Supabase activity workflow');
              
              // ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
              const rawData = fs.readFileSync('generated_data.json', 'utf8');

              // JSONè§£æ
              let contentArray;
              try {
                contentArray = JSON.parse(rawData.trim());
              } catch (parseError) {
                console.error('âŒ JSON parse failed:', parseError.message);
                throw new Error('AI output is not valid JSON');
              }

              // é…åˆ—ã‹ã©ã†ã‹æ¤œè¨¼
              if (!Array.isArray(contentArray)) {
                console.error('âŒ AI output is not an array:', typeof contentArray);
                throw new Error('Expected JSON array but got: ' + typeof contentArray);
              }

              // è¦ç´ ã®å‹æ¤œè¨¼
              const invalidItems = contentArray.filter((item, index) => {
                if (typeof item !== 'string') {
                  console.warn(\`âš ï¸ Item \${index} is not a string:\`, typeof item);
                  return true;
                }
                return false;
              });

              if (invalidItems.length > 0) {
                console.error(\`âŒ Found \${invalidItems.length} non-string items in array\`);
                throw new Error('Array contains non-string elements');
              }

              console.log('âœ… AI output validation passed');
              console.log(\`ğŸ“Š Valid array with \${contentArray.length} string elements\`);

              // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—ã«å¤‰æ›
              const data = contentArray.map(content => ({ content }));
              
              // ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥
              const { error } = await supabase.from(process.env.TABLE_NAME).insert(data);
              if (error) throw error;
              console.log('âœ… Inserted records successfully');
              
              // å¤ã„ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆ24æ™‚é–“ä»¥ä¸Šå‰ï¼‰
              const { error: deleteError } = await supabase
                .from(process.env.TABLE_NAME)
                .delete()
                .lt('created_at', new Date(Date.now() - 24*60*60*1000).toISOString());
              
              if (deleteError) console.warn('âš ï¸ Cleanup warning:', deleteError.message);
              else console.log('ğŸ§¹ Cleaned up old records');
              
              console.log('ğŸ‰ Workflow completed successfully!');
              
            } catch (err) {
              console.error('âŒ Error:', err.message);
              process.exit(1);
            }
          })();
          "
